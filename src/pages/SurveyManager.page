<!--(c) Copyright 2013 Grameen Foundation USA. All rights reserved-->
<apex:page standardController="Survey__c" extensions="SurveyManagerController" sidebar="false" action="{!init}" tabstyle="SurveyManager__tab" id="page">
    <apex:sectionHeader title="{!$Label.HOME}" subtitle="{!$ObjectType.Survey__c.LabelPlural}" />
    <apex:pageMessages id="errorMessage" ></apex:pageMessages>
    <apex:includeScript value="{!$Resource.jquery}" />
    <apex:includeScript value="{!$Resource.jquerySimpleModal}" />
    <apex:includeScript value="{!URLFOR($Resource.js, 'utils.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.encoder, 'Class.create.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.encoder, 'encoder.js')}" />

    <c:blockOverlay label="{!$Label.LOADING}..." callback="loadMoreActions();"/>
    <iframe style="display:none" src="" class="CSVIframe"/>

    <style type="text/css">
    td.noSidebarCell{padding:5px 10px 20px 10px;}
    .errorMessage{
        color:red;
    }
    span.survey-name{font-weight:bold;}
    td[title="Action"] img{width:24px;}
    #simplemodal-overlay {background-color:#000;}
    #simplemodal-container {background-color:white; border:3px solid #444; padding:12px;}
    .popupTitle{
        font-size: 14px;
    }
    .custPopup{
        background-color: white;
        border-width: 2px;
        border-style: solid;
        z-index: 9999;
        left: 50%;
        padding:10px;
        position: absolute;
        /* These are the properties to set the actual popup size*/
        width: 500px;
        margin-left: -250px;
        top:100px;
    }
    .popupBackground{
        background-color:black;
        opacity: 0.20;
        filter: alpha(opacity = 20);
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 9998;
    }
    .popupList{
         font-weight:bold;
         margin-left: 20px;
    }

    #csvExportModal {
        width: 350px;
        display: none;
    }

    #csvExportModal img {
        margin: 10px;
        margin-right: 20px;
    }

    #confirmationClone {
        height:100px;width:250px;display:none;
    }

    .surveyName{
        float: left;
        margin-right: 10px;
    }
    .publishDialog div.buttons{ text-align: right; }
    .publishDialog div.buttons>*{ margin: 0 5px; }
</style>
<!-- Following two scripts are needed to run SOQL from javascript -->
    <script type="text/javascript">
        var __sfdcSessionId = '{!GETSESSIONID()}';
    </script>
    <script src="/soap/ajax/25.0/connection.js" type="text/javascript"></script>

    <script type="text/javascript">

         //SURVEY STATUS TRANSLATIONS
        var slSurveyStatus = {!statusValues};

        //create a format function for strings
        String.prototype.format = function(args) {
            return this.replace(/{(\d+)}/g, function(match, number) {
            return typeof args[number] != 'undefined'
                                            ? args[number]
                                            : match;
            });
        };

        // Helper method to add options to a select list
        function op(val, str, condition){
            return condition == null || condition
                ? '<option value="' + val + '">' + str + '</option>'
                : null ;
        }

        function loadMoreActions(){
            // Clean select lists
            $('select.moreactions').empty();

            // Load actions
            $('select.moreactions').each(function(i,elem){
                var surveyId = $(elem).attr('id').replace('moreactions','');
                var status = $.encoder.encodeForHTML($('.' + surveyId).html());
                var isPPI = $('.' + surveyId).hasClass('isPPI');
                var ppiEditable = {!isPPIEnabled};
                var canDistribute = {!canDistribute};
                var isDistributed = $('.' + surveyId).hasClass('Distributed');
                var surveyName = $.encoder.encodeForHTML($('#name-'+surveyId).html());
                var responses = parseInt($('.responses' + surveyId).text());
                $(elem)
                    .append( op('', '{!JSENCODE($Label.SURVEY_MANAGER_ACTIONS_DO_MORE)}') )
                    .append( op('Preview', '{!JSENCODE($Label.PREVIEW)}') )
                    .append( op('Clone', '{!JSENCODE($Label.SURVEY_MANAGER_ACTIONS_CLONE)}') )
                    .append( op('editXForm', '{!JSENCODE($Label.SURVEY_MANAGER_ACTIONS_EDIT_XFORM)}', (!isPPI || ppiEditable) && status == slSurveyStatus['{!JSENCODE(status_draft)}']) )
                    .append( op('viewXForm', '{!JSENCODE($Label.SURVEY_MANAGER_ACTIONS_VIEW_XFORM)}', status != slSurveyStatus['{!JSENCODE(status_draft)}'] ) )
                    .append( op('-1', '----------', responses) )
                    .append( op('Export', '{!JSENCODE($Label.SURVEY_MANAGER_ACTIONS_EXPORT_CSV)}', responses) )
                    .append( op('-1', '----------', status == slSurveyStatus['{!JSENCODE(status_draft)}']) )
                    .append( op('Delete', '{!JSENCODE($Label.DELETE)}', status == slSurveyStatus['{!JSENCODE(status_draft)}']) )
                    .append( op('Distribute', '{!JSENCODE($Label.SURVEY_MANAGER_ACTIONS_DISTRIBUTE)}', !isDistributed && isPPI && canDistribute && status == slSurveyStatus['{!JSENCODE(status_published)}']) );
            });
        }

        $(document).ready(function(){

            $('.statusFilter').change(function(){
                var filter = $(this).val();
                blockPage();
                doFilterStatus(filter);
            });


        });
        var idToClone = '';
        var confirmAccept = true;
        var MSG_CONFIRM_CLOSE =  "{!JSENCODE($Label.SURVEY_MANAGER_MSG_CONFIRM_CLOSE)}";
        var statusValues = {!statusValues};

        function translateStatus(status){
            return statusValues[status];
        }

        function execMoreAction(surveyId, SelectId){
            surveyId = surveyId.replace("'","\\'");
            $('select.moreactions').attr('disabled','disabled');
            var action = $('#'+surveyId).find(":nth-child(1)").val();
            if (action != null && action != ''){
                if (action == 'Close'){
                    var surveyName = $('#name-' + surveyId).text();
                    if (confirm( MMSG_CONFIRM_CLOSE.format([surveyName] ))) {
                        doMoreAction( action, surveyId );
                    } else {
                        $('select.moreactions').removeAttr('disabled').val('');
                    }
                }else if (action == 'editXForm' || action == 'viewXForm') {
                    window.location = '{!$Page.editXForm}?surveyId=' + surveyId;
                    loadMoreActions();
                }else if (action == 'Preview') {
                    doPreview(surveyId);
                }else if (action =='Clone'){
                    idToClone = surveyId;
                    doClone();
                    $('select.moreactions').removeAttr('disabled').val('');
                }else if (action == 'Export') {
                    doMoreAction(action, surveyId);
                    $('#csvExportModal').modal();
                    $('select.moreactions').removeAttr('disabled').val('');
                }else if (action == 'Delete') {
                    // Workaround to work with safari under windows
                    setTimeout(function() {
                         var confirm = confirmDelete();
                         if(confirm) {
                            doMoreAction( action, surveyId );
                         } else {
                            $('select.moreactions').removeAttr('disabled').val('');
                         }
                    },10);
                }
                else if(action == 'Distribute'){
                    doMoreAction(action, surveyId);
                }
                else if(action == '-1'){
                    $('select.moreactions').removeAttr('disabled').val('');
                }
            }
        }

        function doMoreAction(action, surveyId){

            if (action != 'editXForm' && action != 'Export'){
                blockPage();
            }
            doMoreActionController(action, surveyId);
        }

        function confirmDelete(){
            return confirm("{!JSENCODE($Label.SURVEY_MANAGER_MSG_CONFIRM_DELETE)}");

        }
        function closeSurvey(surveyId){
            var surveyName = $('#name-' + surveyId).text();
            if (confirm( MSG_CONFIRM_CLOSE.format([surveyName]))) {
                doMoreAction( 'Close', surveyId );
            }
        }

        function publish(){
                //send data to the controller
                blockPage();
                $('.publishDialog').hide();
                doPublish();
        }

        //this is the functions that actualy clone the survey
        function doClone(){
            $.modal.close();
            blockPage();
            doMoreActionController('Clone', idToClone);
        }

        function doPreview(surveyId){
            doMoreAction( 'Preview', surveyId );
            loadMoreActions();
        }

        //Check status of xform, show confirm and call action function
        function checkXform(xForm_Status, surveyId){
            if( xForm_Status == '{!XFORM_STATUS_CUSTOM}' && !confirm('{!JSENCODE($Label.SURVEY_MANAGER_CONFIRM_EDIT_CUSTOM)}')){
                confirmAccept = false;
            }
            editSurveyController(surveyId, xForm_Status, confirmAccept)
        }
    </script>
    <div id="confirmationClone">
        <p>{!$Label.SURVEY_MANAGER_ALERT_CLONE_ALERT}</p>
        <form>
            <div style="text-align: right">
                <a href="#" onClick="$.modal.close();">{!$Label.CANCEL}</a>&nbsp;
                <button class="btn" type="button" onClick="doClone()">{!$Label.SURVEY_MANAGER_ALERT_CLONE_SURVEY}</button>
            </div>
        </form>
    </div>

    <div id="csvExportModal">
        <img src="/img/msg_icons/info24.png" align="left" />
        <apex:outputText value="{!$Label.SURVEY_CSV_POPUP}">
            <apex:param value="{!$User.Email}" />
        </apex:outputText>
        <form>
            <div style="text-align: right; margin: 10px;">
                <button class="btn" type="button" onClick="$.modal.close();">{!$Label.OK}</button>
            </div>
        </form>
    </div>

    <apex:form >
        <apex:outputPanel id="publishDialog" styleClass="publishDialog" layout="block">
            <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!displayGroupPopUp}"/>
            <apex:outputPanel styleClass="custPopup" layout="block" rendered="{!displayGroupPopUp}">
                <apex:outputPanel styleClass="popupTitle" layout="block" rendered="{!displayGroupPopUp}">
                    <apex:outputText escape="false" value="{!$Label.SURVEY_MANAGER_MSG_CONFIRM_PUBLISH}">
                       <apex:param value="{!HTMLENCODE(surveyToPublishName)}"/>
                    </apex:outputText>
                </apex:outputPanel>
                    <br/>
                    <hr/>
                    <br/>
                <div class="buttons">
                    <apex:commandLink styleClass="cancelBtn" value="{!$Label.CANCEL}" onclick="$('.publishDialog').hide()" action="{!closeGroupPopup}" rerender="publishDialog"/>
                    <input type="button" styleClass="publishBtn btn" value="{!$Label.PUBLISH}" onclick="publish()" />
                </div>
            </apex:outputPanel>

        </apex:outputPanel>
    </apex:form>

    <apex:form prependId="false">
        <label for="statusFilter">{!$Label.FILTER} </label>
        <apex:selectList id="statusFilter" styleClass="statusFilter" value="{!filter}" multiselect="false" size="1">
            <apex:selectOptions value="{!statusList}"/>
        </apex:selectList>
        <apex:actionFunction reRender="surveys,otpNav2" name="doFilterStatus" action="{!doFilterStatus}" oncomplete="unblockPage();">
            <apex:param id="filter" name="filter" assignTo="{!filter}" value="" />
        </apex:actionFunction>

        <apex:outputPanel layout="block" styleClass="bNext" id="otpNav2">
            <div class="withFilter">
                <div class="next">
                    <span id="pageCount">
                        <apex:variable var="from" value="{!IF(resultSize==0,0,(pageNumber-1) * pageSize + 1)}"/>
                        <apex:variable var="to" value="{!MIN(resultSize,pageNumber * pageSize)}"/>
                        <apex:outputText value="{0,number,0}"><apex:param value="{!from}"/></apex:outputText>-
                        <apex:outputText value="{0,number,0}"><apex:param value="{!to}"/></apex:outputText>&nbsp;of&nbsp;
                        <apex:outputText value="{0,number,0}"><apex:param value="{!resultSize}"/></apex:outputText>
                    </span>
                    <apex:commandLink id="pagePrevLnk" action="{!Previous}" value="<{!$Label.PREV_PAGE}" rendered="{!hasPrevious}"/>
                    <apex:outputText id="pagePrevTxt"  value="{!$Label.PREV_PAGE}" rendered="{!!hasPrevious}"/>
                    <apex:outputText value=" | "/>
                    <apex:commandLink id="pageNextLnk"  value="{!$Label.NEXT_PAGE}>" rendered="{!hasNext}" action="{!Next}"/>
                    <apex:outputText id="pageNextTxt"  value="{!$Label.NEXT_PAGE}" rendered="{!!hasNext}"/>
                    &nbsp;
                </div>
            </div>
        </apex:outputPanel>
    </apex:form>

    <apex:form prependId="false">
    <apex:pageBlock id="surveys">
        <apex:pageBlockButtons id="buttons" location="top">
            <button id="btnCreateNew" class="btn" type="button" onclick="redirect('{!$Page.createSurvey}')">{!$Label.SURVEY_MANAGER_NEW_SURVEY}</button>

            <span style="border-left:black 1px solid;"/>&nbsp;

            <button id="btnCascadingManager" class="btn" type="button" onclick="redirect('{!URLFOR($Action.CascadingSelect__c.List, $ObjectType.CascadingSelect__c)}')">{!$Label.CASCADING_SELECTS}</button>

            <button id="btnTemplateManager" class="btn" type="button" onclick="redirect('{!$Page.TemplateManager}')">{!$Label.TEMPLATE_MANAGER}</button>
        </apex:pageBlockButtons>

        <apex:outputPanel id="errorMessages">
                    <apex:outputText styleClass="errorMessage" value="{!error}"></apex:outputText>
        </apex:outputPanel>
        <apex:pageBlockSection rendered="{!surveyList.size > 0}">

        </apex:pageBlockSection>

            <apex:pageBlocktable id="table" value="{!surveyList}" var="item">
                <apex:column id="colStatus" styleClass="{!item.Survey__r.Id} {!IF(item.Survey__r.IsPPI__c, 'isPPI', '')} {!IF(item.Distributed__c, 'Distributed', '')}" >
                    <apex:facet name="header">
                        <apex:commandLink value="{!$ObjectType.Survey__c.Fields.Status__c.Label}" action="{!doSort}" onclick="blockPage();" oncomplete="unblockPage();"
                            rerender="surveys">
                            <apex:param name="columnOrder" value="Survey__r.Status__c"
                                assignTo="{!columnOrder}" />
                        </apex:commandLink>
                    </apex:facet>
                    <apex:outputText value="{!item.Survey__r.Status__c}" />
                </apex:column>
                <apex:column id="colName" title="Name">
                    <apex:facet name="header">
                        <apex:commandLink value="{!$ObjectType.Survey__c.Fields.Name.Label}" action="{!doSort}" onclick="blockPage();" oncomplete="unblockPage();"
                            rerender="surveys">
                            <apex:param name="columnOrder" value="Survey__r.Name"
                                assignTo="{!columnOrder}" />
                        </apex:commandLink>
                    </apex:facet>
                    <div class="surveyName">
                        <span id="name-{!item.Survey__r.Id}" class="survey-name">{!item.Survey__r.Name}</span><br/>
                        <span id="alias-{!item.Survey__r.Id}" class="survey-alias">{!item.Survey__r.Alias__c}</span>
                    </div>
                    <apex:image rendered="{!item.Distributed__c}" value="{!URLFOR($Resource.img, 'bookmark-new-4-16.png')}"
                                title="{!$Label.SURVEY_LABEL_RELEASEDTOLIBRARY} {!item.DistributionDate__c}" alt="{!$Label.SURVEY_LABEL_RELEASEDTOLIBRARY} {!item.DistributionDate__c}"/>
                </apex:column>
                <apex:column id="colCreatedBy">
                    <apex:facet name="header">
                        <apex:commandLink value="{!$Label.SURVEY_MANAGER_COL_OWNER}" action="{!doSort}" onclick="blockPage();" oncomplete="unblockPage();"
                            rerender="surveys">
                            <apex:param name="columnOrder" value="Survey__r.Owner.Name"
                                assignTo="{!columnOrder}" />
                        </apex:commandLink>
                    </apex:facet>
                    <apex:outputText >
                            {!item.Survey__r.Owner.Name}
                     </apex:outputText>
                    </apex:column>
                <apex:column id="colCreatedDate" >
                    <apex:facet name="header">
                        <apex:commandLink value="{!$ObjectType.Survey__c.Fields.CreatedDate.Label}" action="{!doSort}" onclick="blockPage();" oncomplete="unblockPage();"
                            rerender="surveys">
                            <apex:param name="columnOrder" value="Survey__r.CreatedDate"
                                assignTo="{!columnOrder}" />
                        </apex:commandLink>
                    </apex:facet>
                    <apex:outputText value="{0,date,medium}">
                        <apex:param value="{!item.Survey__r.CreatedDate}" />
                    </apex:outputText>
                </apex:column>
                <apex:column id="colPublishedDate">
                    <apex:facet name="header">
                        <apex:commandLink value="{!$ObjectType.Survey__c.Fields.PublishedDate__c.Label}" action="{!doSort}" onclick="blockPage();" oncomplete="unblockPage();"
                            rerender="surveys">
                            <apex:param name="columnOrder" value="Survey__r.PublishedDate__c"
                                assignTo="{!columnOrder}" />
                        </apex:commandLink>
                    </apex:facet>
                    <apex:outputText value="{0,date,medium}">
                        <apex:param value="{!item.Survey__r.PublishedDate__c}" />&nbsp;
                    </apex:outputText>
                </apex:column>
                <apex:column id="colModifiedDate" >
                    <apex:facet name="header">
                        <apex:commandLink value="{!$ObjectType.Survey__c.Fields.LastModifiedDate.Label}" action="{!doSort}" onclick="blockPage();" oncomplete="unblockPage();"
                            rerender="surveys">
                            <apex:param name="columnOrder" value="Survey__r.LastModifiedDate"
                                assignTo="{!columnOrder}" />
                        </apex:commandLink>
                    </apex:facet>
                    <apex:outputText value="{0,date,medium}" >
                            <apex:param value="{!item.Survey__r.LastModifiedDate}" />&nbsp;
                     </apex:outputText>
                </apex:column>
                <apex:column id="colResponseCount" title="Response">
                <apex:facet name="header">

                        <apex:commandLink value="{!$ObjectType.Survey__c.Fields.ResponseCount__c.Label}" action="{!doSort}" onclick="blockPage();" oncomplete="unblockPage();"
                            rerender="surveys">
                            <apex:param name="columnOrder" value="Survey__r.ResponseCount__c"
                                assignTo="{!columnOrder}" />
                        </apex:commandLink>
                    </apex:facet>
                    <apex:variable var="resultCount" value="{!TEXT(item.Survey__r.ResponseCount__c)}"/>
                    <apex:outputLink styleClass="responses{!item.Survey__r.Id}" value="{!URLFOR($Page.SurveyResult, null, [id=item.Survey__r.Id])}" target="_blank" disabled="{!resultCount == '0'}" > {!resultCount} </apex:outputLink>
                </apex:column>
                <apex:column id="colActions" headerValue="{!$Label.ACTIONS}">
                    <apex:outputpanel >
                        <apex:variable var="isPublishable" value="{!item.Survey__r.Status__c == 'Draft' && item.Survey__r.QuestionCount__c > 0}"/>
                        <apex:variable var="isEditable" value="{!item.Survey__r.Status__c == 'Draft' ||item.Survey__r.Status__c == null}"/>
                        <apex:variable var="isAssignable" value="{!item.Survey__r.Status__c != 'Closed'}"/>
                        <apex:variable var="isReportable" value="{!item.Survey__r.Status__c != null && item.Survey__r.Status__c != 'Draft'}"/>
                        <apex:variable var="isCloseable" value="{!OR(item.Survey__r.Status__c == 'Published',item.Survey__r.Status__c == 'Distributed')}"/>

                        <apex:outputLink onclick="checkXform('{!JSENCODE(item.Survey__r.XForm_Status__c)}','{!JSENCODE(item.Survey__r.id)}')" value="#">
                            <apex:image id="linkEdit" rendered="{!isEditable}" value="{!URLFOR($Resource.img, 'pencil24.png')}" title="{!$Label.SURVEY_MANAGER_EDIT_SURVEY}" alt="{!$Label.SURVEY_MANAGER_EDIT_SURVEY}"/>
                        </apex:outputLink>

                        <apex:image rendered="{!isEditable == false}" value="{!URLFOR($Resource.img, 'pencil24_gray.png')}" title="{!$Label.SURVEY_MANAGER_EDIT_SURVEY}" alt="{!$Label.SURVEY_MANAGER_EDIT_SURVEY}"/>

                        <apex:commandLink action="{!showGroupPopup}" rerender="publishDialog" onclick="blockPage()" oncomplete="unblockPage()">
                            <apex:image id="linkPublish" rendered="{!isPublishable}" value="{!URLFOR($Resource.img, 'publish-24.png')}"  title="{!$Label.SURVEY_MANAGER_PUBLISH_SURVEY}" alt="{!$Label.SURVEY_MANAGER_PUBLISH_SURVEY}"/>
                            <apex:param value="{!item.Survey__r.id}" name="surveyToPublish" assignTo="{!surveyToPublish}"/>
                            <apex:param value="{!item.Survey__r.Name}" name="surveyToPublishName" assignTo="{!surveyToPublishName}"/>
                        </apex:commandLink>
                        <apex:image rendered="{!NOT(isPublishable)}" value="{!URLFOR($Resource.img, 'publish-24-gray.png')}" title="{!$Label.SURVEY_MANAGER_PUBLISH_SURVEY}" alt="{!$Label.SURVEY_MANAGER_PUBLISH_SURVEY}"/>

                        <apex:image id="linkCloseSurvey" style="cursor:pointer;" onClick="closeSurvey('{!item.Survey__r.id}')" rendered="{!isCloseable}"  value="{!URLFOR($Resource.img, 'dialog-cancel-5.png')}" title="{!$Label.SURVEY_MANAGER_CLOSE_SURVEY}" alt="{!$Label.SURVEY_MANAGER_CLOSE_SURVEY}" />
                        <apex:image rendered="{!NOT(isCloseable)}" value="{!URLFOR($Resource.img, 'dialog-cancel-5-gray.png')}" title="{!$Label.SURVEY_MANAGER_CLOSE_SURVEY}" alt="{!$Label.SURVEY_MANAGER_CLOSE_SURVEY}" />

                        &nbsp;
                        <span id="{!item.Survey__r.id}" >
                        <select id="moreactions{!item.Survey__r.id}" class="moreactions" onchange="execMoreAction('{!item.Survey__r.id}','{!$Component.moreOptions}')"/>
                        </span>
                    </apex:outputpanel>
                </apex:column>
            </apex:pageBlocktable>

            <script type="text/javascript">
                // Translate the status of each survey
                $("td[id$='colStatus']").each(function(i,elem){
                    $(this).html(translateStatus($.encoder.encodeForHTML($(this).html())));
                });

                loadMoreActions();

            </script>

            <apex:actionFunction name="doMoreActionController" action="{!doMoreAction}" oncomplete="unblockPage()" rerender="surveys,otpNav2,errorMessage,publishDialog">
                <apex:param id="doAction" name="doAction" assignTo="{!doAction}" value="" />
                <apex:param id="surveyIdAction" name="surveyIdAction" assignTo="{!surveyIdAction}" value="" />
            </apex:actionFunction>

            <apex:actionFunction name="doPublish" action="{!doPublish}" rerender="surveys,otpNav2,errorMessage,publishDialog" oncomplete="unblockPage()">
            </apex:actionFunction>

            <apex:actionFunction name="editSurveyController" action="{!editSurvey}" rerender="surveys,otpNav2,errorMessage,publishDialog">
                <apex:param value="" name="surveyIdToEdit" assignTo="{!surveyIdToEdit}"/>
                <apex:param value="" name="xformStatus"    assignTo="{!xformStatus}"/>
                <apex:param value="" name="confirmAccept"  assignTo="{!confirmAccepted}"/>
            </apex:actionFunction>

   </apex:pageBlock>
    </apex:form>

</apex:page>
